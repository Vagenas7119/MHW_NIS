---
title: "stage_10_3_biotime_mhws"
author: "Shahar Chaikin"
date: "2025-10-01"
output: html_document
---

library
```{r}
library(tidyverse)
```

Load data
#fixed baseline
Abundance
```{r}
#MEDITS data
pseudo_rec_fbl=read.csv("c_int_records_pseudo_first_fbl.csv") #%>% 
  #left_join(read.csv("nis_native_harmo.csv"),by="species")

pseudo_rec_dt=read.csv("c_int_records_pseudo_first_dt.csv") 
```

Load the cleaned biomass data
```{r}
pop_data=read_rds("biotime_std_n.rds") %>% 
  rename(unique_h3_population=unique_pop_id)
```

##1) Using Fredston et al., 2023
###1.1) calculate mean and sum annual biomass
sum hauls within years
```{r}
annual_n=pop_data %>% 
  group_by(unique_h3_population,year) %>% 
  summarise(mean_annual_n=mean(mean_abundance) %>% 
                                round(digits = 3),
            sum_annual_n=sum(mean_abundance) %>% 
                                round(digits = 3),
            used_n=n())
```

flag each year within a specific population group as isolated if it lacks both an immediate preceding and an immediate succeeding year in the dataset.
```{r}
annual_n_flagged <- annual_n %>%
  # 1. Group the data by the unique identifier
  group_by(unique_h3_population) %>%
  
  # 2. Check for the presence of a preceding or successive year
  #    The 'year' vector inside mutate() refers to the years only within the current group.
  mutate(
    # Check if (year - 1) is in the group's years OR if (year + 1) is in the group's years.
    has_neighbor = ((year - 1) %in% year) | ((year + 1) %in% year),
    
    # A year is 'isolated' if it does NOT have a neighbor.
    is_isolated = !has_neighbor
  ) %>%
  
  # 3. Remove the temporary 'has_neighbor' column and ungroup the data
  ungroup() %>%
  select(-has_neighbor)
```

This code chunk calculates the log biomass ratio between consecutive years for each population group, applying a small epsilon correction to zero values to avoid infinite results, and setting the ratio to NA for non-consecutive years.
```{r}
# Define the small increment value
epsilon <- 0.01

annual_n_ratio <- annual_n %>%
  # 1. Group the data by the unique identifier
  group_by(unique_h3_population) %>%
  
  # 2. Arrange by year to ensure correct lagged comparisons
  arrange(year) %>%
  
  # 3. Add the preceding year's biomass and check for consecutiveness
  mutate(
    # Get the biomass from the preceding year in the group
    prev_mean_n = lag(mean_annual_n),
    
    # Get the year from the preceding row in the group
    prev_year = lag(year),
    
    # Check if the current year is exactly one year after the previous row's year
    is_consecutive = (year - prev_year) == 1
  ) %>%
  
  # 4. Calculate the Log Biomass Ratio (t / t-1)
  #    Only calculate if the years are consecutive.
  mutate(
    # Use if_else to apply the correction and calculation only for consecutive years.
    log_n_ratio = if_else(
      is_consecutive,
      {
        # Apply epsilon correction to both numerator (t) and denominator (t-1)
        # to avoid log(0) which is -Inf, and division by zero.
        n_t = mean_annual_n + epsilon
        n_t_minus_1 = prev_mean_n + epsilon
        
        # Calculate log ratio: log(n_t / biomass_{t-1})
        log(n_t / n_t_minus_1)
      },
      # Assign NA if the years are not consecutive
      NA_real_
    ),
  year_of_mhw=year-1) %>%
  
  # 5. Clean up temporary columns and ungroup
  select(-prev_mean_n, -prev_year, -is_consecutive) %>%
  ungroup() %>% 
  drop_na() %>% 
  mutate(h3_id= sapply(str_split(unique_h3_population, "_"), "[[", 3),

    # Split the string by the underscore and take the 3rd element (species)
  survey_id = str_extract(unique_h3_population, "(?<=_)[^_]+"),
  species = str_extract(unique_h3_population, "^[^_]+")) %>% 
  left_join(pop_data %>% 
              distinct(species,is_les),
            by="species") %>% 
  left_join(pop_data %>% 
              distinct(survey_id,type),
            by="survey_id")

annual_n_ratio$log_n_ratio %>% hist()
annual_n_ratio %>% 
  filter(is_les%in%"1") %>% 
  select(log_n_ratio) %>% 
  pull() %>% 
  hist
annual_n_ratio %>% 
  filter(is_les%in%"0") %>% 
  select(log_n_ratio) %>% 
  pull() %>% 
  hist
#write_rds(annual_n_ratio,"annual_n_ratio_biotime.rds")
```