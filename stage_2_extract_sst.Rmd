---
title: "stage_2_extract_sst"
author: "Shahar Chaikin"
date: "2025-09-12"
output: html_document
---

libraries
Install latest developmental version from R-Universe:
```{r eval=FALSE, include=FALSE}
install.packages("CopernicusMarine", repos = c('https://pepijn-devries.r-universe.dev', 'https://cloud.r-project.org'))
```

```{r}
library(CopernicusMarine)
library(tidyverse)
library(stars) # To handle spatiotemporal raster data
```

Hexagons to be used for downloading climatic data
```{r}
hex=read.csv("coords_for_clim_extr.csv")
```

Download a subset
```{r eval=FALSE, include=FALSE}

cms_products_list() %>% view
MMP64_details=cms_product_details(product = "MEDSEA_MULTIYEAR_PHY_006_004")
MMP64_details$properties
MMP64_details$description
MMP64_details$properties$mainVariables

med_test <-
  cms_download_subset(username = "schaikin",
                      password = "Aa123456",
    product       = "MEDSEA_MULTIYEAR_PHY_006_004",
    layer         = "med-cmcc-tem-rean-d",
    variable      = c("thetao"),
    region        = c(30, 32, 30.5, 32.5),
    timerange     = c("2021-01-01"),
    verticalrange = c(-2:0),
    progress      = T
)
med_test
med_test$thetao
med_test %>% str
plot(med_test["thetao"], col = hcl.colors(100), axes = TRUE)
```

Repeat
information
```{r}
USERNAME <- "schaikin" 
PASSWORD <- "Aa123456" 
PRODUCT <- "MEDSEA_MULTIYEAR_PHY_006_004"
LAYER <- "med-cmcc-tem-rean-d_202012"
VARIABLE <- "thetao" # SST variable
# The Copernicus Marine product "MEDSEA_MULTIYEAR_PHY_006_004" starts from 1987.
# We will download data from 1987-01-01 to 2024-12-31.
TIMERANGE <- c("1987-01-01 UTC", "2024-12-31 UTC")
# Vertical range for SST data is typically at or near the surface.
# A range like 0 to -1 meter is a safe bet for SST.
VERTICALRANGE <- c(-2:-1)
# H3 hexagons from your dataframe
h3_ids <- hex$h3_id %>% unique()
```

Output dir.
```{r}
# Set the output directory
output_dir <- "copernicus_data_by_hexagon/MEDSEA_MULTIYEAR_PHY_006_004/"
if (!dir.exists(output_dir)) {
  dir.create(output_dir)}
```

```{r}
# --- Function to download and save data for a single hexagon ---
download_and_save_hexagon <- function(h3_id) {
  # Create the file path
  file_path <- file.path(output_dir, paste0(h3_id, ".rds"))
  
  # Check if file already exists to avoid re-downloading
  if (file.exists(file_path)) {
    message(paste("Skipping", h3_id, "- file already exists."))
    return(NULL)
  }
  
  message(paste("Processing hexagon:", h3_id))
  
  tryCatch({
    # Convert H3 hexagon to a bounding box
    bbox_matrix <- h3::h3_to_geo_boundary(h3_id)[[1]]
    
    bbox <- bbox_matrix %>%
      as_tibble() %>%
      summarise(
        min_lon = min(lng),
        max_lon = max(lng),
        min_lat = min(lat),
        max_lat = max(lat)
      )
    
    # Define the region for cms_download_subset
    region <- c(bbox$min_lon, bbox$min_lat,bbox$max_lon, bbox$max_lat)
    
    # Download the data as a stars object
    data_raw <- cms_download_subset(
      username = USERNAME,
      password = PASSWORD,
      product = PRODUCT,
      layer = LAYER,
      variable = VARIABLE,
      region = region,
      timerange = TIMERANGE,
      verticalrange = VERTICALRANGE,
      progress = TRUE,
      verbose = TRUE
    )
    
    # ---------------------------------------------
    # New code to process stars object into a data frame
    # ---------------------------------------------
    
    # Convert the stars object to a data frame
    df_tidy <- as.data.frame(data_raw) %>%
      # Rename columns to match the desired output
      rename(
        lon = longitude,
        lat = latitude,
        sst = thetao,
        date = time
      ) %>%
      # Add the h3_id column
      mutate(h3_id = h3_id,
         sst=(as.numeric(sst))) %>%
      # Select and reorder columns
      select(h3_id, lat, long = lon, date, sst)
    
    # Save the tidy data frame directly to an RDS file
    saveRDS(df_tidy, file = file_path)
    
    message(paste("Successfully downloaded, processed, and saved data for", h3_id))
    
  }, error = function(e) {
    warning(paste("Error downloading data for", h3_id, ":", e$message))
  })
}
```

#process hexagons in chunks
```{r}
# Split the list of hexagons into chunks to manage downloads
chunk_size <- 1 # Adust this value based on your RAM and internet speed
h3_chunks <- split(h3_ids, ceiling(seq_along(h3_ids) / chunk_size))

# Loop through each chunk and process the hexagons
for (chunk in h3_chunks) {
  walk(chunk, download_and_save_hexagon)
}
```

Test the results
```{r}
test=read_rds("copernicus_data_by_hexagon/MEDSEA_MULTIYEAR_PHY_006_004/832db0fffffffff.rds")

ggplot(test)+
  geom_hex(aes(x=date,y=as.numeric(sst)))
```

